


## **TiTre** : Installer et configurer BIND9 sur Kali linux 2025.3 

**Description:**
Guide pas-à-pas pour installer, configurer, sécuriser et dépanner BIND9 sur Debian 13. Contient exemples de fichiers de zone, vérifications, AppArmor, tests et bonnes pratiques.

# Installer et configurer BIND9 sur Debian 13 (Trixie)

> **But** : fournir un guide reproductible pour installer BIND9 (named) sur Kali linux 2025.3 , créer des zones forward & reverse, activer le logging de manière sûre (AppArmor), tester et dépanner.

---

## Table des matières

- Prérequis
- Installation des paquets
- Structure des fichiers et emplacements
- Exemple de configuration (named.conf.local, named.conf.options)
- Exemples de fichiers de zone (forward & reverse)
- Vérifications et tests
- Logging et AppArmor (autoriser /var/log/bind)
- Commandes utiles (named-checkconf, named-checkzone, rndc)
- Sauvegarde, maintenance et bonnes pratiques
- FAQ & résolution des erreurs courantes


---

## Prérequis

- Kali linux 2025.3  à jour
- Accès `sudo` ou root
- Réseau configuré (IP statique recommandée)
- Ports à ouvrir côté pare-feu : UDP 53, TCP 53 (et TCP 953 si RNDC distant)




## 1) `/etc/bind/named.conf` (inclut les autres fichiers — laissé par défaut souvent)

Garde-le tel quel si présent; l’essentiel est dans `named.conf.options` et `named.conf.local`.  
Vérifie que ces include existent :


```bash
include "/etc/bind/named.conf.options";
include "/etc/bind/named.conf.local";
include "/etc/bind/named.conf.default-zones";
```

## 2) `/etc/bind/named.conf.options`

```javascript
/*
 * named.conf.options
 * Options globales pour le serveur BIND
 * - Recursion limitée au réseau lab
 * - Query logging activé (querylog)
 * - Forwarders configurés en fallback (facultatif)
 */

options {
    directory "/var/cache/bind";             /* emplacement cache BIND */

    // Limiter la récursion (important : éviter open resolver)
    recursion yes;
    allow-recursion { 192.168.100.0/24; localhost; };   /* seuls clients autorisés */

    // Qui peut interroger le serveur (query)
    allow-query { 192.168.100.0/24; localhost; };

    // Forwarders (optionnel) : serveurs à interroger en dernier recours
    forwarders {
        1.1.1.1;
        8.8.8.8;
    };

    // Ne pas valider DNSSEC dans ce lab si tu veux simuler vulnérabilités
    dnssec-validation no;

    // Fichier de logs (querylog) — activé ci-dessous via logging{} ou querylog yes
    querylog yes;

    // Réduire le transfert de zone par défaut : pas d'AXFR globalement ici
    allow-transfer { none; };

    // Réponses EDNS0 max size / autres options peuvent être ajoutées si besoin
};


logging {
    channel default_syslog {
        syslog daemon;
        severity info;
    };

    channel query_log {
        file "/var/log/named/queries.log" versions 5 size 20m;
        severity info;
        print-time yes;
    };

    category default { default_syslog; };
    category queries { query_log; };
    category resolver { query_log; };   /* log des requêtes récursives */
};


```

**Commentaires** :

- `recursion yes` + `allow-recursion { 10.10.10.0/24; };` permet seulement aux machines du lab d’utiliser le serveur comme résolveur.
- `allow-transfer { none; };` interdit par défaut les transferts de zone (AXFR) — nous autoriserons explicitement dans `named.conf.local` si besoin.
- `forwarders` : utiles si le serveur ne résout pas directement toutes les requêtes (peut être laissé vide si tu veux qu’il interroge les racines).

## 3) `/etc/bind/named.conf.local`

```javascript


/*
 * Déclarations des zones autoritatives pour le domaine atte-thm.cg
 * et la zone inverse 10.10.10.in-addr.arpa
 */

zone "atte-thm.cg" {
    type master;
    file "/etc/bind/db.atte-thm.cg";      /* fichier de zone directe */
    /*allow-transfer { 1192.168.100.59; };      exemple : autoriser un secondaire précis (changer) */

};

zone "100.168.192.in-addr.arpa" {
    type master;
    file "/etc/bind/db.192.168.100";         /* fichier de zone inverse */
    /* allow-transfer { 192.168.100.59; };      restreindre AXFR */

};

```


**Commentaires** :

- `allow-transfer` : remplace `none` défini globalement ; mets l’IP d’un serveur esclave si tu testes la réplication. Si tu n’as pas d’esclave, garde `allow-transfer { none; };` pour plus de sécurité.
- `also-notify` : utile si tu veux que BIND notifie des serveurs esclaves d’un changement.

---

## 4) `/etc/bind/db.atte-thm.cg` (zone directe)

Fichier de zone avec commentaires (utilise `;` pour commentaires dans zone file) :

```javascript
$TTL 3600               ; TTL par défaut = 1 heure
@       IN      SOA ns1.atte-thm.cg. admin.atte-thm.cg. (
                2025110802  ; Serial YYYYMMDDnn (incrémenter à chaque modif)
                3600        ; Refresh (1h)
                900         ; Retry (15m)
                604800      ; Expire (7d)
                86400       ; Negative Cache TTL (1d)
        )
; Serveurs de noms
@       IN      NS      ns1.atte-thm.cg.
@       IN      A       192.168.100.59

; Enregistrements A/AAAA
ns1     IN      A       192.168.100.59
www     IN      A       192.168.100.59     ; Serveur web de test
;mail   IN      A       10.10.10.60     ; Mail server (exemple)

; Enregistrement MX pour la gestion du mail (priorité 10)
;@      IN      MX      10      mail.atte-thm.cg.

; Autres exemples
;ftp    IN      CNAME   www
```

**Commentaires** :

- Le `SOA` : mets le serial au format `YYYYMMDDnn` pour faciliter le suivi. Incrémente `nn` si tu fais plusieurs modifications le même jour.
- Ajoute tous les hôtes clients/serveurs que tu veux simuler (ex: `camera1`, `printer1`, etc.) pour les logs DNS et le ciblage lors des tests.
___
---

## 5) `/etc/bind/db.10.10.10` (zone inverse)

```javascript

$TTL 3600
@       IN      SOA ns1.atte-thm.cg. admin.atte-thm.cg. (
                2025110801 ; Serial
                3600
                900
                604800
                86400 )
@       IN      NS      ns1.atte-thm.cg.

; PTR records for 192.168.100/24
59      IN      PTR     ns1.atte-thm.cg.     ; 10.10.10.2 -> ns1
59      IN      PTR     www.atte-thm.cg.     ; 10.10.10.50 -> www
;60     IN      PTR     mail.atte-thm.cg.    ; 10.10.10.60 -> mail

```

**Commentaires** :

- La zone inverse s’appelle `10.10.10.in-addr.arpa` et chaque enregistrement PTR mappe la dernière octet (ex : `50`) à un nom FQDN.
- Assure-toi que PTR et A correspondent (cohérence). Certains services (mail) exigent un PTR correct.

___
---

## 6) Logging : activer des logs dédiés pour BIND

Ajoute/édite un bloc `logging` (par exemple dans `/etc/bind/named.conf` ou `/etc/bind/named.conf.options`) : 

NB: J'essayer de le mentionner ici pour vous dire que vous le choix. Pour mon cas, j'ai voulu le mettre dans le fichier de  **`/etc/bind/named.conf`**

```javascript
logging {
    channel default_syslog {
        syslog daemon;
        severity info;
    };

    channel query_log {
        file "/var/log/named/queries.log" versions 5 size 20m;
        severity info;
        print-time yes;
    };

    category default { default_syslog; };
    category queries { query_log; };
    category resolver { query_log; };   /* log des requêtes récursives */
};

```

Puis crée le répertoire et permissions :
```Pjavascript
sudo mkdir -p /var/log/named
sudo chown bind:bind /var/log/named
sudo chmod 750 /var/log/named

```

### Optionnel
- Si tu veux que rsyslog redirige les logs nominatifs, ajoute (optionnel) `/etc/rsyslog.d/10-bind.conf` :

	- Redémarre rsyslog :
	```javascript
	sudo systemctl restart rsyslog
	```


## 7) Commandes utiles (vérification & gestion)

Vérifier la syntaxe globale :
```javascript
sudo named-checkconf    # aucun output = OK
```

Vérifier une zone (exemple) :

```javascript
sudo named-checkzone atte-thm.cg /etc/bind/db.atte-thm.cg
sudo named-checkzone 100.168.192.in-addr.arpa /etc/bind/db.192.168.100
```

## 8) Rotation des logs & permissions

Créer le répertoire logs si nécessaire et permissions :

```javascript
sudo mkdir -p /var/log/named
sudo chown bind:bind /var/log/named
sudo chmod 750 /var/log/named
```

Exemple simple logrotate `/etc/logrotate.d/named` :

```powershell
/var/log/named/*.log {
    weekly
    missingok
    rotate 6
    compress
    delaycompress
    notifempty
    create 640 bind bind
    sharedscripts
    postrotate
        /usr/sbin/rndc reload >/dev/null 2>&1 || true
    endscript
}
```

## 9) Cas d’erreurs courantes & debug

- Si `named-checkconf` échoue → regarde précisément la ligne indiquée.
- Si zones non chargées malgré `systemctl start` → vérifier ownership des fichiers (`bind:bind`) et permissions.
- Si `rndc` refuse la connexion → vérifier `/etc/bind/rndc.key` et correspondance dans `/etc/rndc.conf` (ou include automatique).
- Pour logs vides → vérifier bloc `logging {}` dans named.conf et que BIND peut écrire dans le fichier.

Commande utile pour diagnostiquer sockets:
```javascript
ss -ltnp | grep named
```

## 10) Exemples rapides (copier-coller)

Reload d’une zone après modification :

```javascript
sudo named-checkzone atte-thm.cg /etc/bind/db.atte-thm.cg && sudo rndc reload atte-thm.cg
```

```mermaid
graph TD

A[( Jusqu'ici avec les commande bind pour verifier si tous se passe bien, je n'avais pas des erreurs?
Mais une choses, bisares est que lorsque je teste le resolution inverse, rien ne
voulais marcher, après je fait des recherche en ligne pour avoir ce quoi suite)]
```


# Ce que nous devons faire meintenant:

- fait une **sauvegarde** du fichier de zone,
- **ajoute** l’enregistrement A pour l’apex `atte-thm.cg` pointant sur `192.168.100.59`,
- **incrémente** automatiquement le `Serial` du SOA (+1),
- **vérifie** la zone avec `named-checkzone`.

### 1) Sauvegarde (obligatoire)

```javascript
sudo cp -v /etc/bind/db.atte-thm.cg /etc/bind/db.atte-thm.cg.bak.$(date +%Y%m%d%H%M%S)
```

### 2) Ajouter l’enregistrement A pour l’apex (`@`) juste après la ligne NS
(Cette commande insère la ligne `@ IN A 192.168.100.59` immédiatement après la ligne `@ ... NS ...`.)

```javascript
sudo bash -c 'awk '\''{ print } /IN[[:space:]]+NS/ && !x { print "@\tIN\tA\t192.168.100.59"; x=1 }'\'' /etc/bind/db.atte-thm.cg > /etc/bind/db.atte-thm.cg.new && mv /etc/bind/db.atte-thm.cg.new /etc/bind/db.atte-thm.cg && echo "apex A ajouté."'
```

Si tu préfères l’ajouter ailleurs manuellement, ouvre `sudo nano /etc/bind/db.atte-thm.cg` et ajoute la ligne :

```javascript
@   IN   A   192.168.100.59
```

### 3) Incrémenter automatiquement le Serial (safety: incrémente le nombre trouvé dans le SOA)

(Cette ligne incrémente le nombre du Serial ; elle suppose un Serial numérique comme `2025110801` — exactement ce que tu as.)
```javascript
sudo perl -0777 -i -pe 's/(\n\s*)(\d{9,12})(\s*;\s*Serial)/$1.($2+1).$3/eg' /etc/bind/db.atte-thm.cg && echo "Serial incrémenté."
```

Explication : perl recherche le nombre suivi de `; Serial` et l'incrémente de +1 (incrementation sûre même si tu fais plusieurs modifications la même journée).

### 4) Vérifier la zone avec `named-checkzone`

```javascript
sudo named-checkzone atte-thm.cg /etc/bind/db.atte-thm.cg
```


## **Juste après ces manips, tout commçait à fonctionner corrrectement**

